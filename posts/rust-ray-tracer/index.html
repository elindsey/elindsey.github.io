<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=data:,%89PNG%0D%0A%1A%0A><link rel=stylesheet href=/style.css><link rel=canonical href=https://siliconsprawl.com/posts/rust-ray-tracer/><title>Porting a C99 Ray Tracer to Rust</title><meta name=author content="Eli Lindsey"><meta property="og:url" content="https://siliconsprawl.com/posts/rust-ray-tracer/"><meta property="og:site_name" content="silicon_sprawl_"><meta property="og:title" content="Porting a C99 Ray Tracer to Rust"><meta property="og:description" content="I needed to pick up Rust for work, so I ported my existing ray tracer to the language for a little practice. It’s now in the unimaginatively named ecl_rt.
Overall it was a pleasant experience. I particularly like Rust’s object system (am I allowed to call it that?), the bounded generics, how it handles numeric primitives (requiring explicit conversion, giving easy, explicit control of overflow behavior), the focus on expressions, and the rayon library. The ML aspects are refreshing, but easy to overdo."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-27T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-27T00:00:00+00:00"></head><body><header role=banner class=site-header><div class=wrapper><a class=site-title href=https://siliconsprawl.com/>silicon_sprawl_</a><nav class=site-nav><a class=page-link href=/about/ title=about>about</a></nav></div></header><main class=page-content><div class=wrapper><article><header class=post-header><h1 class="post-title p-name">Porting a C99 Ray Tracer to Rust</h1></header><div class="post-content e-content"><p>I needed to pick up Rust for work, so I ported my existing ray tracer to the
language for a little practice. It&rsquo;s now in the unimaginatively named
<a href=https://github.com/elindsey/ecl_rrt>ecl_rt</a>.</p><p>Overall it was a pleasant experience. I particularly like Rust&rsquo;s object system
(am I allowed to call it that?), the bounded generics, how it handles numeric
primitives (requiring explicit conversion, giving easy, explicit control of
overflow behavior), the focus on expressions, and the rayon library. The
ML aspects are refreshing, but easy to overdo.</p><p>The development environment is fairly good, though I did hit a bug in rust
analyzer and at one point had to wipe my build directory because cargo got
confused and everything started failing to link.</p><p>The initial port was ~40% slower than the equivalent C99 codebase. Replacing
the rand crate with the same custom PRNG I use in
<a href=https://github.com/elindsey/ecl_rt_legacy>ecl_rt_legacy</a> closed the gap to 15-20%. That&rsquo;s
still much higher than I&rsquo;d like, but I haven&rsquo;t had time to dig into it in
depth. I can say that it&rsquo;s not related to threading and nothing in the Rust
assembly looks <em>too</em> off - bounds checking isn&rsquo;t hurting me very much, there
aren&rsquo;t a lot of extra function calls, etc. It seems that clang is optimizing
the giant wad of floating point calculations slightly better, but I haven&rsquo;t
looked into what exactly it&rsquo;s doing differently.</p><h3 id=whiteout>Whiteout</h3><p><img src=2.png alt></p><p>My initial render wasn&rsquo;t too far off - at least it made an image! I forgot to average the pixel color values back down, so everything trended towards full white the longer the ray tracer ran.</p><h3 id=upside-down>Upside Down</h3><p><img src=3.png alt></p><p>With whiteout fixed, the next obvious problem is the image is upside down. This is common because images are represented as a giant flat buffer of pixel values, so when you go from an in memory representation to an image library or format you need to agree on how that buffer is stacked and unstacked, ie. does the first item in the buffer correspond to the top left or the bottom left pixel of the image. So I just reversed the buffer&mldr;</p><h3 id=mirrored-colors>Mirrored Colors</h3><p><img src=4.png alt></p><p>Oops. In reversing the buffer I accidentally reversed my color channels, so red is blue and blue is red.</p><h3 id=band-artifacts>Band Artifacts</h3><p><img src=bad1.png alt></p><p>I flipped the colors, but tried to get too clever with the PRNG. In this image I tried to seed my PRNG with the thread ID - which would be fine, except rayon was calling my seed function each time it checked out work from the job pool. Instead of a thread seeding once, it would reseed with the thread ID approximately fifty times over the course of the run. This causes visibile artifacting and the bands you see in the image. Rather than adjust it to only seed once, I opted to used the rand crate for reseeding (it&rsquo;s so few calls that the overhead is negligible).</p><h3 id=finally>Finally&mldr;</h3><p><img src=5.png alt></p><p>And now everything is sorted and we&rsquo;re comparable to the ecl_rt reference image!</p></div></article></div></main><footer class="site-footer h-card"><div class=wrapper><div class=footer-col-wrapper><div class="footer-col footer-col-1"><a class=u-email href=mailto:eli@siliconsprawl.com>eli@siliconsprawl.com</a></div><div class="footer-col footer-col-2"><ul class=social-media-list><li><a href=https://github.com/elindsey><svg class="svg-icon"><use xlink:href="/social-icons.svg#github"/></svg></a></li><li><a href=https://www.linkedin.com/in/elilind><svg class="svg-icon"><use xlink:href="/social-icons.svg#linkedin"/></svg></a></li><li><a href=https://siliconsprawl.com/feed.xml><svg class="svg-icon"><use xlink:href="/social-icons.svg#rss"/></svg></a></li></ul></div></div></div></footer></body></html>