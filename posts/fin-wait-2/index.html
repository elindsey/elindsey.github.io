<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=data:,%89PNG%0D%0A%1A%0A><link rel=stylesheet href=/style.css><link rel=canonical href=https://siliconsprawl.com/posts/fin-wait-2/><title>FIN_WAIT_2</title><meta name=author content="Eli Lindsey"><meta property="og:url" content="https://siliconsprawl.com/posts/fin-wait-2/"><meta property="og:site_name" content="silicon_sprawl_"><meta property="og:title" content="FIN_WAIT_2"><meta property="og:description" content="Many people are familiar with the 3-way handshake used to establish TCP, but may not be as familiar with the 4-way (occasionally 3-way) handshake used to close a TCP connection, ie. the bottom left section of this diagram:
The happy case for shutting down a connection is that the client sends a FIN to the server and receives an ACK, then receives a FIN from the server and sends an ACK."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-07T00:00:00+00:00"></head><body><header role=banner class=site-header><div class=wrapper><a class=site-title href=https://siliconsprawl.com/>silicon_sprawl_</a><nav class=site-nav><a class=page-link href=/about/ title=about>about</a></nav></div></header><main class=page-content><div class=wrapper><article><header class=post-header><h1 class="post-title p-name">FIN_WAIT_2</h1></header><div class="post-content e-content"><p>Many people are familiar with the 3-way handshake used to establish TCP, but may
not be as familiar with the 4-way (occasionally 3-way) handshake used to close a
TCP connection, ie. the bottom left section of this diagram:</p><p><img src=tcp_state_diagram.png alt="tcp state diagram"></p><p>The happy case for shutting down a connection is that the client sends a FIN to
the server and receives an ACK, then receives a FIN from the server and sends an
ACK.</p><p>But the server isn&rsquo;t necessarily under our control and may not be well-behaved,
and there&rsquo;s a flaky network between them to boot. What happens when things go
wrong? In other words, what happens if we send a FIN, receive an ACK, then never
hear from the server again?</p><p>Strictly according to the RFCs, the socket will land in the FIN_WAIT_2 state
indefinitely, waiting for a FIN that will never come. The transition from
FIN_WAIT_2 to CLOSED is entirely application driven, so there would be nothing
to bail unsuspecting application developers out of this state if it weren&rsquo;t for
most operating systems choosing to deviate slightly from the standard.
Specifically, if a socket is shutdown such that the application will never read
nor write to it again (eg. <code>shutdown(sock, SHUT_RDWR)</code> or <code>close()</code>), the kernel
will apply a timeout to automatically transition from FIN_WAIT_2 to CLOSED
(controlled by <code>net.ipv4.tcp_fin_timeout</code> on Linux and <code>finwait2_timeout</code> on
FreeBSD). Thus the common case is covered and most people will never need to
think about this.</p><p>However! If you&rsquo;re dealing with half-closed connections (<code>shutdown(sock, SHUT_RD/SHUT_WR)</code>) then those protections aren&rsquo;t applicable and it again becomes
easy to shoot yourself in the foot by accumulating an ever increasing number of
connections in FIN_WAIT_2. I&rsquo;ve primarily seen this come up when working on
proxies that terminate at TCP, often for passthrough proxying with SNI sniffing -
when you don&rsquo;t have visibility into the upper layer protocols it often makes
sense to structure the code as two separate half-duplex paths and use half-close
semantics. If you do this be aware of the FIN_WAIT_2 state and consider
reimplementing some form of idle timeout to transition the socket from
FIN_WAIT_2 to CLOSED.</p></div></article></div></main><footer class="site-footer h-card"><div class=wrapper><div class=footer-col-wrapper><div class="footer-col footer-col-1"><a class=u-email href=mailto:eli@siliconsprawl.com>eli@siliconsprawl.com</a></div><div class="footer-col footer-col-2"><ul class=social-media-list><li><a href=https://github.com/elindsey><svg class="svg-icon"><use xlink:href="/social-icons.svg#github"/></svg></a></li><li><a href=https://www.linkedin.com/in/elilind><svg class="svg-icon"><use xlink:href="/social-icons.svg#linkedin"/></svg></a></li><li><a href=https://siliconsprawl.com/feed.xml><svg class="svg-icon"><use xlink:href="/social-icons.svg#rss"/></svg></a></li></ul></div></div></div></footer></body></html>